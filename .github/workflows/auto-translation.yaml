name: Auto Translation

on:
  pull_request:
    paths:
      - content/english/**
       
jobs:
  auto-translate:
    runs-on: ubuntu-latest
    continue-on-error: true

    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the
      # added or changed files to the repository.
      contents: write
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref || github.ref }}
        submodules: true
        fetch-depth: 0  # Changed from 2 to 0 to get full history

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: List files to be translated
      run: |
        echo "Files that will be translated:"
        find content -name "*.md" -path "*/english/*" -type f

    - name: Check translation tool structure
      run: |
        echo "Translation tool directory structure:"
        ls -la translation-tool/
        echo ""
        echo "Looking for .csproj files:"
        find translation-tool/ -name "*.csproj"

    - name: Debug changed files
      run: |
        echo "=== Git diff output ==="
        git diff --name-only -r HEAD^1 HEAD
        echo ""
        echo "=== Filtered English markdown files ==="
        git diff --name-only -r HEAD^1 HEAD | grep '^content/english/.*/[^/]*\.md$' || echo "No matching files found"
        echo ""
        echo "=== Current branch ==="
        git branch -vv
        echo ""
        echo "=== Last 5 commits ==="
        git log --oneline -5
        echo ""
        echo "=== Comparing to master ==="
        git diff --name-only origin/master...HEAD | grep '^content/english/.*/[^/]*\.md$' || echo "No English markdown files changed compared to master"

    - name: Run Translation Tool
      env:
        GITHUB_TOKEN: ${{ secrets.MODELS_TOKEN }}
      run: |
        set -x  # Enable verbose mode
        languages=("french" "spanish" "portuguese" "german" "kyrgyz" "simplified-chinese" "traditional-chinese")
        
        echo "=== Checking for changed files (comparing to master) ==="
        # Compare to master branch instead of just HEAD^1
        changed_files=$(git diff --name-only origin/master...HEAD | grep '^content/english/.*/[^/]*\.md$' || true)
        
        echo "Changed files found:"
        echo "$changed_files"
        
        if [ -z "$changed_files" ]; then
          echo "No changed English markdown files found. Exiting gracefully."
          exit 0
        fi
        
        for file in $changed_files; do
          echo "=== Translating $file ==="
          
          # Check if file exists
          if [ ! -f "$file" ]; then
            echo "Warning: File $file does not exist, skipping..."
            continue
          fi
          
          for lang in "${languages[@]}"; do
            echo "=== Running WorkShopTranslationV2 tool for language: $lang ==="
            
            # Run with error handling
            if dotnet run --project "translation-tool/WorkshopAutoTranslation/WorkShopTranslationV2/WorkShopTranslationV2.csproj" -- "$file" "$lang" 2>&1; then
              echo "✓ Translation completed for $lang"
            else
              exit_code=$?
              echo "✗ Translation failed for $lang (exit code: $exit_code)"
              # Don't exit, continue with other translations
            fi
          done
        done
        
        echo "=== Translation process completed ==="
        
        # Show what files were created
        echo "=== Checking for newly created translation files ==="
        git status --short

    - name: Create Pull Request with AI-Generated Translations
      uses: peter-evans/create-pull-request@v7
      with:
        commit-message: "Add AI translations for new workshop content"
        title: "[Github Actions] AI Workshop Translations - #${{ github.event.pull_request.number }}"
        body: "This PR generates AI translations for new English workshop content in this pull request [here](${{ github.event.pull_request.html_url }})."
        branch: "auto-translation-suggestions-${{ github.event.pull_request.number }}"
        labels: "translation, auto-generated"
        base: "master"